<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <title>Aprenda WA</title>
    </head>
    <body>
        <h1>Aprendendo WebAssembly</h1>
        <script>
            // Carrega string da memória empregada pelo WebAssembly
            const readStrFromMem = (offset, length) => {
                const buffer = wasm.instance.exports.memory.buffer;
                const strBuffer = new Uint8Array(buffer, offset, length);
                const str = new TextDecoder().decode(strBuffer);
                
                const objeto = { detail: str };
                window.dispatchEvent(new CustomEvent("wasmValue", objeto));
            }

            window.addEventListener("wasmValue", objeto => {
                console.log("Received:", objeto.detail);
            })

            // Objeto que indica funções implementadas em JavaScript
            // chamadas por código em C. O objeto abaixo disponibiliza
            // para código em C a função 'log'.
            const imports = {
                env : {
                    log : console.log
                }
            };

            // Carrega o módulo WASM
            const moduloWasm = fetch('/program.wasm');
            
            // Compila, inicia e disponibiliza o WASM
            WebAssembly.instantiateStreaming(moduloWasm, imports)
            .then(wasm => {
                // Disponibiliza WebAssembly Module (WASM)
                window.wasm = wasm;

                console.log('WASM pronto...');  

                // WASM: o que o módulo exporta para uso em JavaScript
                console.log('exports', WebAssembly.Module.exports(wasm.module));              

                // WASM: o que o módulo importa para seu próprio uso.
                console.log('imports', WebAssembly.Module.imports(wasm.module));
            }).catch(erro => {
                console.log("Erro ao carregar WASM");
                console.log(erro.toString());
            });
        </script>
    </body>
</html>