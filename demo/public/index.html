<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <title>Aprenda WA</title>
    </head>
    <body>
        <h1>Aprendendo WebAssembly</h1>
        <script>
            const strLog = (offset, length) => {
                console.log(offset, length);
                const buffer = wasm.instance.exports.memory.buffer;
                const strBuffer = new Uint8Array(buffer, offset, length);
                const str = new TextDecoder().decode(strBuffer);
                
                window.dispatchEvent(new CustomEvent("wasmValue", { detail: str}));
            }

            window.addEventListener("wasmValue", str => {
                console.log("Received:", str.detail);
            })

            // Objeto que indica funções em JavaScript
            // chamadas por código em C.
            const imports = {
                env : {
                    strLog
                }
            };

            // Compila e inicia o módulo WebAssembly
            WebAssembly.instantiateStreaming(fetch('/program.wasm'), imports)
            .then(wasm => {
                console.log('WASM pronto...');
                window.wasm = wasm;
            });
        </script>
    </body>
</html>